class b{constructor(){this.cart=JSON.parse(localStorage.getItem("menuCart"))||[],this.init()}init(){this.bindCartModal(),this.updateCartDisplay()}saveCart(){localStorage.setItem("menuCart",JSON.stringify(this.cart))}bindCartModal(){const t=document.getElementById("floatingCart"),e=document.querySelector(".close-modal"),a=document.querySelector(".checkout-btn"),o=document.getElementById("cartModal");t&&t.addEventListener("click",()=>this.openCartModal()),e&&e.addEventListener("click",()=>this.closeCartModal()),a&&a.addEventListener("click",()=>this.checkout()),document.addEventListener("click",i=>{i.target===o&&this.closeCartModal()})}addToCart(t){var d,n,l;const e=t.dataset.id,a=(d=t.querySelector(".item-title span:first-child"))==null?void 0:d.textContent,o=(n=t.querySelector(".item-price"))==null?void 0:n.textContent.replace("KZ ","").replace(".","").replace(",","."),i=parseFloat(o),s=(l=t.querySelector(".item-image img"))==null?void 0:l.src;if(!e||!a||isNaN(i))return;const c=this.cart.find(u=>u.id===e);c?c.quantity+=1:this.cart.push({id:e,title:a,price:i,image:s,quantity:1}),this.saveCart(),this.updateCartDisplay(),this.showAddedFeedback(t)}showAddedFeedback(t){const e=t.querySelector(".add-to-cart");if(!e)return;const a=e.innerHTML;e.innerHTML='<i class="fas fa-check"></i> Adicionado',e.style.background="#27ae60",setTimeout(()=>{e.innerHTML=a,e.style.background=""},2e3)}updateCartDisplay(){const t=document.querySelector(".cart-count");if(t){const a=this.cart.reduce((o,i)=>o+i.quantity,0);t.textContent=a,t.style.display=a>0?"flex":"none"}const e=document.getElementById("cartModal");e&&e.style.display==="flex"&&this.updateCartModal()}updateCartModal(){const t=document.querySelector(".cart-items"),e=document.getElementById("cartTotal");if(!t)return;if(!this.cart.length){t.innerHTML='<p class="empty-cart-message">Seu carrinho está vazio.</p>',e&&(e.textContent="KZ 0,00");return}t.innerHTML="";let a=0;this.cart.forEach((o,i)=>{const s=o.price*o.quantity;a+=s;const c=document.createElement("div");c.className="cart-item",c.innerHTML=`
                <div class="cart-item-info">
                    <div class="cart-item-title">${o.title}</div>
                    <div class="cart-item-price">KZ ${o.price.toFixed(2).replace(".",",")} × ${o.quantity}</div>
                </div>
                <div class="cart-item-actions">
                    <div class="quantity-controls">
                        <button class="quantity-btn minus" data-index="${i}">-</button>
                        <span>${o.quantity}</span>
                        <button class="quantity-btn plus" data-index="${i}">+</button>
                    </div>
                    <button class="remove-item" data-index="${i}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `,t.appendChild(c)}),e&&(e.textContent=`KZ ${a.toFixed(2).replace(".",",")}`),this.bindCartItemButtons()}bindCartItemButtons(){document.querySelectorAll(".quantity-btn.minus").forEach(t=>{t.onclick=e=>{const a=parseInt(e.currentTarget.dataset.index);this.updateQuantity(a,-1)}}),document.querySelectorAll(".quantity-btn.plus").forEach(t=>{t.onclick=e=>{const a=parseInt(e.currentTarget.dataset.index);this.updateQuantity(a,1)}}),document.querySelectorAll(".remove-item").forEach(t=>{t.onclick=e=>{const a=parseInt(e.currentTarget.dataset.index);this.removeItem(a)}})}updateQuantity(t,e){this.cart[t].quantity+=e,this.cart[t].quantity<=0&&this.cart.splice(t,1),this.saveCart(),this.updateCartDisplay()}removeItem(t){this.cart.splice(t,1),this.saveCart(),this.updateCartDisplay()}openCartModal(){this.updateCartModal();const t=document.getElementById("cartModal");t&&(t.style.display="flex")}closeCartModal(){const t=document.getElementById("cartModal");t&&(t.style.display="none")}async checkout(){if(!this.cart.length){Swal.fire({icon:"warning",title:"Carrinho vazio",text:"Adicione produtos antes de finalizar o pedido.",confirmButtonColor:"#d33"});return}const t=document.getElementById("customerName"),e=document.getElementById("customerTable"),a=t==null?void 0:t.value.trim(),o=e==null?void 0:e.value.trim();if(!a){Swal.fire({icon:"error",title:"Nome obrigatório",text:"Por favor, digite seu nome.",confirmButtonColor:"#d33"});return}if(!o){Swal.fire({icon:"error",title:"Mesa obrigatória",text:"Por favor, informe a mesa em que você está.",confirmButtonColor:"#d33"});return}try{const i=this.cart.map(n=>{if(!n.id)throw new Error("Todos os produtos precisam ter um ID válido para salvar o pedido.");return{product_id:n.id,quantity:n.quantity,price:n.price}}),s=i.reduce((n,l)=>n+l.price*l.quantity,0);let c=!1;try{const n=await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({items:i,total:s,customer_name:a,customer_table:o})});if(!n.ok)throw new Error(`Erro HTTP! status: ${n.status}`);const l=await n.json();l.success?(c=!0,console.log("Pedido salvo com sucesso no servidor. ID:",l.order_id)):console.warn("Erro ao salvar pedido:",l.message||l)}catch(n){console.warn("Não foi possível salvar o pedido no servidor:",n)}let d=`Olá! Meu nome é ${a} (Mesa ${o}).
Gostaria de fazer o seguinte pedido:

`;this.cart.forEach(n=>{d+=`• ${n.quantity}x ${n.title} - KZ ${(n.price*n.quantity).toFixed(2).replace(".",",")}
`}),d+=`
Total: KZ ${s.toFixed(2).replace(".",",")}

`,c||(d+=`Observação: Pedido não registrado no sistema.

`),d+="Agradeço desde já!",window.open(`https://wa.me/+244936351564?text=${encodeURIComponent(d)}`,"_blank"),this.cart=[],this.saveCart(),this.updateCartDisplay(),t&&(t.value=""),e&&(e.value=""),Swal.fire({icon:"success",title:"Pedido enviado!",text:"Seu pedido foi enviado com sucesso para o WhatsApp.",confirmButtonColor:"#28a745"})}catch(i){console.error("Erro no checkout:",i),Swal.fire({icon:"error",title:"Erro",text:"Ocorreu um erro ao processar o pedido.",confirmButtonColor:"#d33"})}}}window.loadMenuData=async function(){const r=document.querySelector(".category-filters"),t=document.querySelector(".menu-items");if(!(!r||!t))try{t.innerHTML='<div class="loading-state"><i class="fas fa-spinner fa-spin"></i><p>Carregando menu...</p></div>';const[e,a]=await Promise.allSettled([fetch("/api/categories"),fetch("/api/products")]);let o=[],i=[];if(e.status==="fulfilled"&&e.value.ok){const s=await e.value.json();o=Array.isArray(s)?s:s.data||[]}else o=await q();if(a.status==="fulfilled"&&a.value.ok){const s=await a.value.json();i=Array.isArray(s)?s:s.data||[]}else i=await x();M(o,r),E(i,t)}catch(e){console.error("Erro ao carregar menu:",e),t.innerHTML='<div class="error-state"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar produtos.</p><button onclick="loadMenuData()">Tentar Novamente</button></div>'}};async function q(){return[{id:1,name:"Bebidas",slug:"bebidas"},{id:2,name:"Petiscos",slug:"petiscos"},{id:3,name:"Pratos",slug:"pratos"},{id:4,name:"Sobremesas",slug:"sobremesas"}]}async function x(){return[{id:1,name:"Vinho Tinto Reserva",description:"Vinho tinto selecionado da casa",price:25.9,image:"/images/vinho.jpg",category:{slug:"bebidas"}},{id:2,name:"Cerveja Artesanal",description:"Cerveja premium 500ml",price:18.5,image:"/images/cerveja.jpg",category:{slug:"bebidas"}},{id:3,name:"Tabua de Queijos",description:"Seleção de queijos especiais",price:45,image:"/images/queijos.jpg",category:{slug:"petiscos"}},{id:4,name:"Azeitonas Temperadas",description:"Azeitonas com ervas finas",price:12,image:"/images/azeitonas.jpg",category:{slug:"petiscos"}}]}function M(r,t){t.innerHTML='<button class="category-filter active" data-category="all">Todos</button>',r.forEach(e=>{const a=document.createElement("button");a.className="category-filter",a.dataset.category=e.slug,a.textContent=e.name,t.appendChild(a)})}function E(r,t){if(t.innerHTML="",!r.length){t.innerHTML='<p class="no-products">Nenhum produto disponível.</p>';return}r.forEach(e=>{const a=T(e);t.appendChild(a)}),w()}function T(r){var o,i,s,c;const t=document.createElement("div");t.className="menu-item",t.dataset.id=r.id,t.dataset.category=((o=r.category)==null?void 0:o.slug)||"sem-categoria",t.dataset.categoryName=((i=r.category)==null?void 0:i.name)||"Sem categoria",t.dataset.description=r.description||"Sem descrição";const e=parseFloat(r.price)||0,a=r.image?"/storage/"+r.image:"https://via.placeholder.com/300x200?text=Sem+Imagem";return t.innerHTML=`
        <div class="item-image">
            <img src="${a}" alt="${r.name}"
                 onerror="this.src='https://via.placeholder.com/300x200?text=Imagem+Não+Encontrada'">
        </div>
        <div class="item-info">
            <div class="item-title">
                <span>${r.name}</span>
                <span class="item-price">KZ ${e.toFixed(2).replace(".",",")}</span>
            </div>
            <div class="item-category">${((s=r.category)==null?void 0:s.name)||"Sem categoria"}</div>
            <p class="item-desc">${((c=r.description)==null?void 0:c.substring(0,60))||"Sem descrição"}...</p>
            <div class="item-actions">
                <button class="view-details-btn"><i class="fas fa-eye"></i> Ver Detalhes</button>
                <button class="add-to-cart"><i class="fas fa-cart-plus"></i> Adicionar</button>
            </div>
        </div>
    `,t}function w(){const r=window.menuCart||new b;window.menuCart=r,document.querySelectorAll(".add-to-cart").forEach(e=>{e.onclick=a=>{const o=a.target.closest(".menu-item");o&&r.addToCart(o)}}),document.querySelectorAll(".category-filter").forEach(e=>{e.onclick=a=>{const o=a.currentTarget.dataset.category;k(o),document.querySelectorAll(".category-filter").forEach(i=>i.classList.remove("active")),a.currentTarget.classList.add("active")}});const t=document.getElementById("searchInput");t&&(t.oninput=e=>I(e.target.value)),A(r)}function k(r){document.querySelectorAll(".menu-item").forEach(t=>{r==="all"||t.dataset.category===r?t.style.display="block":t.style.display="none"})}function I(r){const t=r.toLowerCase().trim();document.querySelectorAll(".menu-item").forEach(e=>{var i,s;const a=((i=e.querySelector(".item-title span:first-child"))==null?void 0:i.textContent.toLowerCase())||"",o=((s=e.querySelector(".item-desc"))==null?void 0:s.textContent.toLowerCase())||"";a.includes(t)||o.includes(t)?e.style.display="block":e.style.display="none"})}function A(r){const t=document.getElementById("productModal");if(!t)return;const e=t.querySelector(".modal-image img"),a=t.querySelector(".modal-title"),o=t.querySelector(".modal-category"),i=t.querySelector(".modal-description"),s=t.querySelector(".modal-price"),c=t.querySelector(".modal-add-to-cart"),d=t.querySelector(".close-modal");document.querySelectorAll(".view-details-btn").forEach(n=>{n.onclick=l=>{var m,p,y;const u=l.target.closest(".menu-item");if(!u)return;const g=(m=u.querySelector(".item-title span:first-child"))==null?void 0:m.textContent,f=(p=u.querySelector(".item-price"))==null?void 0:p.textContent.replace("KZ ","").replace(".","").replace(",","."),h=parseFloat(f),v=(y=u.querySelector(".item-image img"))==null?void 0:y.src,C=u.dataset.description||"Sem descrição",S=u.dataset.categoryName||"Sem categoria";e.src=v,a.textContent=g,o.textContent=`Categoria: ${S}`,i.textContent=C,s.textContent=`KZ ${h.toFixed(2).replace(".",",")}`,t.style.display="flex",c.onclick=()=>{r.addToCart(u),t.style.display="none"}}}),d.onclick=()=>t.style.display="none",window.onclick=n=>{n.target===t&&(t.style.display="none")}}document.addEventListener("DOMContentLoaded",()=>{console.log("Menu Digital inicializando..."),loadMenuData()});
